From 608733f386e42699325b3d956ed28e1619ad5fea Mon Sep 17 00:00:00 2001
From: Zhenyu Qi <qzydustin@hotmail.com>
Date: Sat, 13 Dec 2025 14:04:51 -0700
Subject: [PATCH] qualcommax: ipq60xx: enable dual-boot and fix sysupgrade for 360v6

This patch combines two commits:
1. Enable dual-partition upgrade support for Qihoo 360v6
2. Fix sysupgrade by removing OEM UBI volumes

Add dual-partition upgrade support for Qihoo 360v6 by utilizing
the existing alfa_bootconfig_rootfs_rotate function. This enables
safe system upgrades with automatic failover capability.

The device uses Qualcomm's bootconfig structure with a slot flag
at offset 0x94 (0:bootconfig partition) to control A/B partition
switching. The bootloader dynamically maps physical NAND partitions
to logical MTD devices based on this flag, ensuring firmware always
writes to the inactive partition.

Also remove OEM UBI volumes (wifi_fw and ubi_rootfs) from the alternate
partition before performing sysupgrade. These volumes are created by
the stock firmware and are not automatically cleaned by the standard
nand_upgrade_prepare_ubi() function, which only removes volumes named
'kernel', 'rootfs', and 'rootfs_data'.

Without this cleanup, the remaining OEM volumes consume available space,
causing the creation of rootfs_data to fail during sysupgrade.

Hardware details:
- SoC: Qualcomm IPQ6000
- Flash: NAND with dual rootfs partitions (mtd16/mtd17)
- Bootconfig: offset 0x94 controls slot selection
- Same mechanism as Alfa Network AP120C-AX

Installation:
Standard sysupgrade process. After upgrade, the system will boot
from the new partition while preserving the old system as backup.

Tested on Qihoo 360v6 running stock firmware and OpenWrt.

Signed-off-by: Zhenyu Qi <qzydustin@hotmail.com>
---
 .../qualcommax/ipq60xx/base-files/lib/upgrade/platform.sh   | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/target/linux/qualcommax/ipq60xx/base-files/lib/upgrade/platform.sh b/target/linux/qualcommax/ipq60xx/base-files/lib/upgrade/platform.sh
index d31363521f..066210a62f 100644
--- a/target/linux/qualcommax/ipq60xx/base-files/lib/upgrade/platform.sh
+++ b/target/linux/qualcommax/ipq60xx/base-files/lib/upgrade/platform.sh
@@ -117,8 +117,14 @@ platform_do_upgrade() {
 		;;
 	glinet,gl-ax1800|\
 	glinet,gl-axt1800|\
-	netgear,wax214|\
+	netgear,wax214)
+		nand_do_upgrade "$1"
+		;;
 	qihoo,360v6)
+		CI_UBIPART="rootfs_1"
+		remove_oem_ubi_volume wifi_fw
+		remove_oem_ubi_volume ubi_rootfs
+		alfa_bootconfig_rootfs_rotate "0:bootconfig" "148"
 		nand_do_upgrade "$1"
 		;;
 	netgear,wax610|\
